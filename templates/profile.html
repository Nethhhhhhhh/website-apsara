{% extends "base.html" %}

{% block title %}My Profile - Apsara Premium{% endblock %}

{% block content %}
<div class="container">
    <!-- Header Section -->
    <div class="card" style="margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem;">
        <div style="position: relative;">
            <div id="avatar-container"
                style="width: 100px; height: 100px; border-radius: 50%; background: #333; overflow: hidden; border: 2px solid var(--primary-gold); position: relative; cursor: pointer;">
                {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" style="width: 100%; height: 100%; object-fit: cover;" id="profile-img">
                {% else %}
                <svg viewBox="0 0 24 24" fill="var(--text-muted)" style="width: 100%; height: 100%; padding: 10px;"
                    id="profile-placeholder">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                {% endif %}

                <!-- Overlay for upload hint -->
                <div id="avatar-overlay"
                    style="position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                    <span style="font-size: 1.5rem;">ðŸ“·</span>
                    <span style="font-size: 0.7rem; color: white;">Change</span>
                </div>
            </div>
            <input type="file" id="avatar-input" style="display: none;" accept="image/*">

            <div
                style="position: absolute; bottom: 0; right: 0; background: var(--primary-gold); color: black; border-radius: 50%; padding: 4px; border: 2px solid var(--bg-dark);">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; display: block;">
                    <path
                        d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11h-14zm14 2c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-1h14v1z" />
                </svg>
            </div>
        </div>

        <div style="flex: 1;">
            <h1 style="margin: 0; font-size: 2rem;">{{ user.full_name }}</h1>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; align-items: center;">
                <span
                    style="color: var(--primary-gold); font-weight: 600; display: flex; align-items: center; gap: 4px;">
                    PREMIUM MEMBER
                </span>
                <span style="color: var(--text-muted);">ID: {{ user.id }}</span>
                {% if user.role in ['admin', 'super_admin'] %}
                <a href="/admin" class="btn-sm btn-outline"
                    style="margin-left: 10px; color: var(--primary-gold); border-color: var(--primary-gold);">Dashboard</a>
                {% endif %}
            </div>
        </div>

        <div style="text-align: right;">
            <div style="color: var(--text-muted); font-size: 0.9rem;">Subscription Plan</div>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-light);">Gold Annual</div>
            <div style="color: var(--primary-gold); font-size: 0.9rem; margin-top: 4px;">Valid until Dec 2026</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">

        <!-- Left Column -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <!-- Personal Info (Editable) -->
            <div class="card">
                <h3
                    style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem; margin-bottom: 1.5rem;">
                    Personal Information
                </h3>

                <form id="profile-form" onsubmit="event.preventDefault(); updateProfile();">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" id="full_name" class="form-input" value="{{ user.full_name }}" required>
                        </div>
                        <div>
                            <label class="form-label">Username (Email)</label>
                            <input type="text" id="username" class="form-input"
                                value="{{ user.username or user.email }}" disabled style="opacity: 0.7;">
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--text-muted);">Change Password</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="password" id="current_password" class="form-input"
                                placeholder="Current Password">
                            <input type="password" id="new_password" class="form-input" placeholder="New Password"
                                oninput="checkStrength()">
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <div
                                style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                                <div id="strength-bar"
                                    style="width: 0%; height: 100%; background: var(--secondary-red); transition: width 0.3s, background 0.3s;">
                                </div>
                            </div>
                            <small id="strength-text" style="color: var(--text-muted); font-size: 0.8rem;">Password
                                Strength</small>
                        </div>
                        <div style="margin-top: 1rem;">
                            <input type="password" id="confirm_password" class="form-input"
                                placeholder="Confirm New Password">
                        </div>
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>

            <!-- Telegram API Settings -->
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Telegram API Settings</h3>
                <form action="/auth/update_credentials" method="POST"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="grid-column: 1 / -1;">
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Connect your Telegram account to use advanced tools.
                        </p>
                    </div>
                    <div>
                        <label class="form-label">API ID</label>
                        <input type="text" name="api_id" class="form-input" value="{{ user.api_id or '' }}" required>
                    </div>
                    <div>
                        <label class="form-label">Phone Number</label>
                        <input type="text" name="phone" class="form-input" value="{{ user.phone or '' }}" required>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label class="form-label">API Hash</label>
                        <input type="text" name="api_hash" class="form-input" value="{{ user.api_hash or '' }}"
                            required>
                    </div>
                    <div style="grid-column: 1 / -1; margin-top: 0.5rem;">
                        <button type="submit" class="btn btn-outline" style="width: 100%;">Update & Connect</button>
                    </div>
                </form>
            </div>

            <!-- Security Settings (2FA) -->
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Security</h3>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin-bottom: 0.5rem;">Two-Factor Authentication</h4>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Add an extra layer of security to your account.
                        </p>
                    </div>
                    <div>
                        {% if user.two_factor_secret %}
                        <span class="badge badge-primary" style="margin-right: 1rem;">Enabled</span>
                        <button onclick="disable2FA()" class="btn btn-outline"
                            style="border-color: var(--secondary-red); color: #ef4444;">Disable</button>
                        {% else %}
                        <span class="badge badge-secondary" style="margin-right: 1rem;">Disabled</span>
                        <button onclick="setup2FA()" class="btn btn-outline">Enable</button>
                        {% endif %}
                    </div>
                </div>

                <!-- 2FA Setup Area (Hidden by default) -->
                <div id="2fa-setup-area"
                    style="display: none; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 1rem;">1. Scan this QR code with your Authenticator App (Google Auth,
                            Authy, etc.)</p>
                        <img id="qr-image" src="" style="background: white; padding: 10px; border-radius: 8px;">
                        <p style="margin-top: 1rem; font-family: monospace; color: var(--primary-gold);"
                            id="secret-code"></p>
                    </div>
                    <div style="max-width: 300px; margin: 0 auto;">
                        <p style="margin-bottom: 0.5rem;">2. Enter the verification code</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="verify-code" class="form-input" placeholder="000 000"
                                style="text-align: center;">
                            <button onclick="confirm2FA()" class="btn btn-primary">Verify & Enable</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Existing updateProfile function ...

            async function setup2FA() {
                const res = await fetch('/api/auth/2fa/setup', { method: 'POST' });
                const data = await res.json();

                document.getElementById('qr-image').src = data.qr_url;
                document.getElementById('secret-code').innerText = data.secret;
                document.getElementById('2fa-setup-area').style.display = 'block';

                // Store secret temporarily in global scope or closure?
                window.tempSecret = data.secret;
            }

            async function confirm2FA() {
                const code = document.getElementById('verify-code').value;
                if (!code) return alert('Please enter code');

                const formData = new FormData();
                formData.append('secret', window.tempSecret);
                formData.append('code', code.replace(/\s/g, ''));

                const res = await fetch('/api/auth/2fa/enable', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert('2FA Enabled Successfully!');
                    location.reload();
                } else {
                    alert('Invalid Code');
                }
            }

            async function disable2FA() {
                const password = prompt("Enter your password to disable 2FA:");
                if (!password) return;

                const formData = new FormData();
                formData.append('password', password);

                try {
                    const res = await fetch('/api/auth/2fa/disable', {
                        method: 'POST',
                        body: formData
                    });

                    if (res.ok) {
                        alert('2FA Disabled');
                        location.reload();
                    } else {
                        alert('Incorrect Password');
                    }
                } catch (e) {
                    alert('Error');
                }
            }
        </script>

        <!-- Right Column (Sidebar) -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">

            <!-- Activity Summary -->
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Overview</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="color: var(--text-muted);">Status</span>
                        <span style="color: #4ade80;">Active</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="color: var(--text-muted);">Joined</span>
                        <span>{{ user.created_at.strftime('%b %Y') }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-muted);">Downloads</span>
                        <span style="color: var(--primary-gold); font-weight: bold;">124</span>
                    </div>
                </div>
            </div>

            <!-- Premium Support -->
            <div class="card" style="background: linear-gradient(to bottom, rgba(255, 215, 0, 0.05), transparent);">
                <h3 style="margin-bottom: 1rem;">Premium Support</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
                    Need help? Our team is available 24/7 for premium members.
                </p>
                <a href="https://t.me/blehhhhhhhhhhhhhhhhhhhhhhhh" target="_blank" class="btn btn-primary"
                    style="width: 100%;">Contact Support</a>
                <a href="/logout" class="btn btn-outline"
                    style="width: 100%; margin-top: 1rem; border-color: var(--secondary-red); color: #ef4444; justify-content: center;">Logout</a>
            </div>
        </div>

    </div>
</div>
{% endblock %}